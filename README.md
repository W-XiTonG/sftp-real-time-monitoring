# SFTP 文件监控与传输工具

## 一、项目概述

本项目是一个基于 Go 语言开发的 SFTP 文件监控与传输工具，它能够实现本地文件与远程 SFTP 服务器之间的文件上传和下载操作。用户可以通过配置文件灵活设置各项参数，如连接信息、传输方式、监控间隔等，以满足不同场景下的文件传输需求。

## 二、功能特性

### 1. 上传功能

- **文件上传**：支持将本地单个文件上传到远程 SFTP 服务器指定路径。当本地文件发生创建或修改事件时，程序会自动将其上传到远程服务器。
- **目录上传**：若配置支持目录上传，程序会递归上传本地目录及其所有子目录和文件到远程服务器。在上传过程中，会在远程服务器上创建相应的目录结构。
- **增量 / 全量传输**：用户可以选择增量或全量的传输方式。增量传输仅上传本地有更新的文件，而全量传输会上传指定路径下的所有文件。
- **文件删除**：在传输完成后，若配置允许，可以选择删除本地源文件，节省本地存储空间。

### 2. 下载功能

- **文件下载**：能够从远程 SFTP 服务器下载单个文件到本地指定路径。程序会定期检查远程服务器上的文件变化，若有新文件或文件大小发生变化，则进行下载。
- **目录下载**：支持下载远程服务器上的目录及其所有子目录和文件到本地。同样会在本地创建相应的目录结构。
- **增量 / 全量传输**：与上传功能类似，可选择增量或全量下载方式。增量下载仅下载有更新的文件，全量下载则会下载指定远程目录下的所有文件。
- **文件删除**：下载完成后，若配置允许，可以选择删除远程服务器上的源文件。
- **定时监控**：对于下载功能，用户可以配置定时监控的时间间隔，程序会按照设定的时间定期检查远程服务器上的文件变化。

### 3. 实时监控

- **本地文件监控**：使用`fsnotify`库对本地指定目录进行实时监控，当文件发生创建、修改、删除、重命名或权限更改等事件时，程序会记录相应的日志信息，并根据配置决定是否进行上传操作。
- **远程文件监控**：定期检查远程 SFTP 服务器上指定目录的文件变化，通过比较文件大小来判断文件是否有更新，从而决定是否进行下载操作。

### 4. 配置灵活

- **配置文件管理**：通过`config.yaml`文件进行配置，用户可以方便地修改连接信息（如服务器地址、端口、用户名、密码）、传输方式（上传或下载、增量或全量）、监控间隔、是否支持目录传输以及传输后是否删除源文件等参数。
- **日志配置**：支持将日志信息同时输出到标准输出和指定的日志文件中，方便用户查看和排查问题。

### 5. 错误处理与重试机制

- **连接错误处理**：在与 SFTP 服务器建立连接时，若出现连接失败的情况，程序会记录错误日志并终止操作。
- **文件操作错误处理**：在文件上传、下载、创建或删除等操作过程中，若出现错误，程序会记录相应的错误信息，并根据情况进行重试或终止操作。

## 三、安装与配置

### 1. 安装依赖

确保你的 Go 环境已经安装，并且版本为 1.24.0 或更高。项目依赖的包会在`go.mod`和`go.sum`文件中列出，可以使用以下命令下载依赖：

```sh
go mod tidy
```

### 2. 配置文件

项目的配置文件为`config.yaml`，可以根据需要修改以下配置项：

```yaml
# SFTP服务端地址
host: "192.168.236.159"
# SFTP服务端端口
port: 22
# 登录SFTP的账号
username: "bssuser"
# 登录SFTP的密码
password: "bssuser"
# 日志配置
logFile: "logs/log.txt"
# 使用方式：1-本地上传到远程；2-远程下载到本地
manner: 1
# 检测间隔，单位：s为秒，m为分钟（仅远程下载到本地有效，本地上传为实时）
TimeInterval: 5s
# 是否支持（上传/下载）目录：true-支持；false-不支持
SupportCatalogs: true
# 上传/下载方式：1-增量；2-全量
incrementalFull: 1
# 上传下载后是否删除：true-删除；false-不删除（只有增量可以使用）
whetherDelete: true
# 本地路径
LocalPaths: "/data/sftp"
# 远程路径
RemotePaths: "/upload"
```

## 四、使用方法

### 1. 上传文件或目录

将`config.yaml`中的`manner`配置为`1`，然后运行以下命令：

```sh
go run main.go
```

### 2. 下载文件或目录

将`config.yaml`中的`manner`配置为`2`，然后运行以下命令：

```sh
go run main.go
```

## 五、代码结构

- `main.go`：项目的入口文件，根据配置文件选择上传或下载功能。

- `internal/config`：配置文件的读取和解析，提供获取配置信息的接口。

- ```
  internal/monitor
  ```

  ：文件监控和传输的核心逻辑，包括本地文件监控和远程文件监控。

  - `localWatcher.go`：实现本地文件监控功能，当本地文件发生变化时触发上传操作。
  - `remoteWatcher.go`：实现远程文件监控功能，定期检查远程服务器上的文件变化并触发下载操作。

- ```
  internal/sftpClient
  ```

  ：SFTP 客户端的实现，包括连接、上传、下载、删除等操作。

  - `client.go`：封装了与 SFTP 服务器的连接、文件上传、下载、目录操作和删除等功能。

- ```
  internal/handler
  ```

  ：文件处理的逻辑，包括本地文件上传到远程服务器的具体实现。

  - `handler.go`：处理本地文件上传的逻辑，根据配置决定是否上传目录以及是否删除本地源文件。

- ```
  internal/utils
  ```

  ：工具函数的实现，如日志记录器的初始化。

  - `logger.go`：实现日志记录器的初始化，将日志信息同时输出到标准输出和指定的日志文件中。

## 六、未来扩展优化方向

### 1. 安全性优化

- **主机密钥验证**：在生产环境中，应该使用更安全的主机密钥验证方式，避免使用`ssh.InsecureIgnoreHostKey()`，以防止中间人攻击。
- **加密传输**：可以考虑使用更高级的加密算法来保护数据传输的安全性，确保文件在传输过程中不被窃取或篡改。
- **用户认证增强**：支持使用私钥认证方式，提高用户认证的安全性。

### 2. 性能优化

- **并发处理**：在上传和下载大量文件时，可以使用并发处理来提高性能。例如，使用 goroutine 并发上传或下载多个文件，减少传输时间。
- **缓存机制**：引入缓存机制，避免重复下载或上传相同的文件。可以使用文件哈希值或文件修改时间来判断文件是否有更新。
- **网络优化**：优化网络连接和数据传输，减少网络延迟和带宽占用。例如，使用连接池技术复用 SFTP 连接，提高连接效率。

### 3. 功能扩展

- **文件过滤**：支持根据文件类型、文件名、文件大小等条件过滤需要上传或下载的文件，提高传输的针对性。
- **事件通知**：在文件上传或下载完成后，通过邮件、短信、消息队列等方式通知用户，方便用户及时了解文件传输状态。
- **错误处理和重试机制**：增加更完善的错误处理和重试机制，提高系统的稳定性。例如，在网络故障或文件操作失败时，自动进行重试，并记录重试次数和结果。
- **断点续传**：实现文件的断点续传功能，当传输过程中出现中断时，可以从断点处继续传输，减少数据传输的重复工作。

### 4. 监控和日志

- **实时监控**：实现实时监控功能，通过 Web 界面或命令行工具，方便用户随时了解文件传输的状态、进度和错误信息。
- **日志分析**：对日志进行分析，提供统计信息和异常报警。例如，统计文件传输的成功率、失败率、传输速度等指标，当出现异常情况时及时通知管理员。

### 5. 配置管理

- **动态配置**：支持动态修改配置文件，无需重启程序即可生效。可以通过 HTTP 接口或配置中心实现动态配置更新。
- **多环境配置**：支持不同环境（开发、测试、生产）的配置管理，方便在不同环境中部署和使用。

## 七、贡献与反馈

如果你对本项目有任何建议或问题，欢迎在 Gitee 上提交 issue 或 pull request。我们会尽快处理并回复。

或者联系作者：2751799737@qq.com